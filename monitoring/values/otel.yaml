namespaceOverride: "observability"
mode: deployment
image:
  repository: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-k8s
command:
  name: "otelcol-k8s"

clusterRole:
  create: true
  rules:
  - apiGroups:
    - ''
    resources:
    - 'pods'
    - 'nodes'
    - 'services'
    - 'endpoints'
    - 'namespaces'
    verbs:
    - 'get'
    - 'list'
    - 'watch'

config:
  receivers:
    prometheus:
      config:
        scrape_configs:
          - job_name: 'kubernetes-pods'
            kubernetes_sd_configs:
              - role: pod
            relabel_configs:
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                action: keep
                regex: true
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                action: replace
                target_label: __metrics_path__
                regex: (.+)
              - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
                action: replace
                regex: '(.+):(?:\d+);(\d+)'
                replacement: '$1:$2'
                target_label: __address__
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318

  processors:
    # transform/accesslogs:
    #   log_statements:
    #     - context: log
    #       statements:
    #       - parse_json(body, attributes)
    #       - set(attributes["status_code"], attributes["response_code"])
    #       - set(attributes["path"], attributes["path"])

    resource:
      attributes:
        - key: k8s.cluster.environment
          value: sandbox
          action: insert
        - key: k8s.cluster.name
          value: kind-demo
          action: insert

    batch: {}

    memory_limiter:
      check_interval: 1s
      limit_mib: 400
      spike_limit_mib: 100

  exporters:
    # debug:
    #   verbosity: detailed

    otlphttp/prometheus:
      endpoint: "http://prometheus-server.observability.svc.cluster.local:80/api/v1/otlp"

    otlp/jaeger:
      endpoint: "jaeger-collector.observability.svc.cluster.local:14250"
      tls:
        insecure: true

    otlphttp/loki:
      endpoint: "http://loki.observability.svc.cluster.local:3100/otlp"
      tls:
        insecure: true

  service:
    pipelines:
      metrics:
        receivers: [prometheus, otlp]
        processors: [resource, memory_limiter, batch]
        exporters: [otlphttp/prometheus]

      traces:
        receivers: [otlp, jaeger]
        processors: [resource, memory_limiter, batch]
        exporters: [otlp/jaeger]

      logs:
        receivers: [otlp]
        processors: [resource, memory_limiter, batch]
        exporters: [otlphttp/loki]